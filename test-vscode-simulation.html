<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" 
        content="default-src 'none'; 
                 script-src 'self' 'unsafe-inline'; 
                 style-src 'self' 'unsafe-inline'; 
                 img-src 'self' https: data:; 
                 font-src 'self';">
  <title>OpenAPI Preview</title>
  <link rel="stylesheet" href="dist/webview/styles.min.css">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: #1e1e1e;
      color: #d4d4d4;
    }
    
    #content {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    
    #elements {
      width: 100%;
      height: 100%;
    }
    
    #error-container {
      padding: 20px;
      text-align: center;
    }
    
    .error-message {
      color: #f48771;
      background-color: #5a1d1d;
      border: 1px solid #be1100;
      padding: 16px;
      border-radius: 4px;
      margin: 20px auto;
      max-width: 600px;
    }
    
    .error-title {
      font-weight: bold;
      margin-bottom: 8px;
    }
    
    #status {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #333;
      color: #fff;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      z-index: 10000;
    }
  </style>
</head>
<body>
  <div id="status">Loading...</div>
  <div id="content">
    <div id="error-container" style="display: none;">
      <div class="error-message">
        <div class="error-title">Error Loading Preview</div>
        <div id="error-text"></div>
      </div>
    </div>
    <elements-api
      id="elements"
      apiDescriptionDocument="openapi: 3.0.0&#10;info:&#10;  title: Test API&#10;  version: 1.0.0&#10;  description: A test API for validation&#10;paths:&#10;  /users:&#10;    get:&#10;      summary: Get users&#10;      responses:&#10;        &#39;200&#39;:&#10;          description: Success&#10;          content:&#10;            application/json:&#10;              schema:&#10;                type: array&#10;                items:&#10;                  $ref: &#39;#/components/schemas/User&#39;&#10;  /posts:&#10;    get:&#10;      summary: Get posts&#10;      responses:&#10;        &#39;200&#39;:&#10;          description: Success&#10;components:&#10;  schemas:&#10;    User:&#10;      type: object&#10;      properties:&#10;        id:&#10;          type: integer&#10;        name:&#10;          type: string"
      layout="sidebar"
      router="hash"
      style="display: block; width: 100%; height: 100%;"
    />
  </div>

  <script src="dist/webview/web-components.min.js"></script>
  <script>
    (function() {
      const status = document.getElementById('status');
      const elementsApi = document.getElementById('elements');
      const errorContainer = document.getElementById('error-container');
      const errorText = document.getElementById('error-text');

      // Simulate vscode API
      const vscode = {
        postMessage: (msg) => {
          console.log('Message to extension:', msg);
          status.textContent = 'Ready ✓';
          status.style.background = '#0a0';
        }
      };
      window.acquireVsCodeApi = () => vscode;

      // Listen for messages (simulated)
      window.addEventListener('message', event => {
        try {
          const message = event.data;
          console.log('Received message:', message);
          
          switch (message.type) {
            case 'update':
              elementsApi.setAttribute('apiDescriptionDocument', message.content);
              elementsApi.style.display = 'block';
              errorContainer.style.display = 'none';
              status.textContent = 'Updated ✓';
              break;
              
            case 'error':
              showError(message.message);
              break;
          }
        } catch (error) {
          console.error('Error handling message:', error);
          showError('An unexpected error occurred: ' + error.message);
        }
      });

      function showError(message) {
        errorText.textContent = message;
        errorContainer.style.display = 'block';
        elementsApi.style.display = 'none';
        status.textContent = 'Error ✗';
        status.style.background = '#c00';
      }

      // Global error handler
      window.addEventListener('error', (event) => {
        console.error('Unhandled error:', event.error);
        event.preventDefault();
      });

      // Global promise rejection handler
      window.addEventListener('unhandledrejection', (event) => {
        console.error('Unhandled promise rejection:', event.reason);
        event.preventDefault();
      });

      // Notify extension that webview is ready
      vscode.postMessage({ type: 'ready' });
      
      // Check if elements loaded
      setTimeout(() => {
        if (elementsApi.shadowRoot) {
          console.log('Elements API shadow DOM created');
          status.textContent = 'Loaded ✓';
          status.style.background = '#0a0';
        } else {
          console.warn('Elements API shadow DOM not found');
          status.textContent = 'Warning: No shadow DOM';
          status.style.background = '#fa0';
        }
      }, 2000);
    })();
  </script>
</body>
</html>
